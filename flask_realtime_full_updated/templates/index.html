
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Real-time Stock + Fuzzy Dashboard</title>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
/* ==== BACKGROUND IMAGE ==== */
body {
  background: url('/static/images/background.jpg') no-repeat center center fixed;
  background-size: cover;
  margin: 0;
  padding: 0;
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
}

/* Dark transparent overlay */
.overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(3px);
  z-index: 1;
}

/* Content wrapper */
.content-container {
  position: relative;
  z-index: 5;
  padding: 20px;
  color: white;
}

/* ===== TITLE ===== */
h2 {
  color: #b7d9ff;
  text-shadow: 0 0 8px rgba(0,150,255,0.9);
  font-size: 28px;
  margin-bottom: 20px;
}

/* ====== CONTROL PANEL ===== */
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  align-items:center;
  padding: 15px;
  border-radius: 12px;
  background: rgba(0,0,0,0.45);
  box-shadow: 0 0 10px rgba(0,200,255,0.2);
  margin-bottom:20px;
}

/* Labels & Inputs */
label {
  font-size: 15px;
  font-weight: 600;
  color: #d9edff;
}

input, select {
  padding: 6px 8px;
  border-radius: 6px;
  border: none;
  outline: none;
  background: rgba(255,255,255,0.85);
  font-size: 15px;
}

/* ===== BLUE NEON BUTTON ===== */
.btn {
  background: linear-gradient(90deg,#006aff,#00c8ff);
  color:white;
  border:none;
  padding:10px 18px;
  font-weight:700;
  border-radius:10px;
  cursor:pointer;
  box-shadow: 0 0 10px rgba(0,170,255,0.8);
  transition:0.2s;
}
.btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(0,200,255,1);
}

/* ===== STATUS ===== */
#status {
  font-size: 14px;
  color: #b0d7ff;
  font-weight: bold;
}

/* ===== METRIC ===== */
#metric {
  font-size: 22px;
  font-weight: 800;
  margin-top: 10px;
  margin-bottom: 10px;
  text-shadow: 0 0 8px rgba(0,200,255,0.8);
}
#metric span {
  color: #5af0ff;
}

/* ===== CHART BOX STYLING ===== */
.chart-box {
  background: rgba(0,0,0,0.45);
  border-radius: 12px;
  padding: 10px;
  margin-top: 10px;
  box-shadow: 0 0 12px rgba(0,150,255,0.25);
}
</style>
</head>

<body>
<div class="overlay"></div>
<div class="content-container">

<h2>ðŸ“ˆ Real-time Stock Price + Live Fuzzy Envelope</h2>

<!-- CONTROL PANEL -->
<div class="controls">
  <label>Symbol: <input id="symbol" value="AAPL" /></label>

  <label>Interval:
    <select id="interval">
      <option>1m</option><option>2m</option><option>5m</option>
      <option>15m</option><option>1h</option>
    </select>
  </label>

  <label>Refresh (s): <input id="refresh" type="number" value="5" min="1" style="width:70px"/></label>
  <label>Window: <input id="window" type="number" value="120" min="10" style="width:80px"/></label>
  <label>Clusters: <input id="n_clusters" type="number" value="3" min="2" max="6" style="width:60px"/></label>
  <label>m: <input id="m" type="number" value="2.0" step="0.1" min="1.1" max="3.0" style="width:70px"/></label>

  <button id="start" class="btn">Start</button>
  <button id="stop" class="btn">Stop</button>

  <div id="status">Stopped</div>
</div>

<!-- METRIC -->
<div id="metric">Price: <span id="price">--</span> <small id="delta"></small></div>

<!-- PRICE CHART -->
<div class="chart-box">
  <div id="chart" style="height:500px;"></div>
</div>

<!-- MEMBERSHIP CHART -->
<div class="chart-box">
  <div id="membership" style="height:260px;"></div>
</div>

<script>
let evtSource = null;
let lastPrice = null;

function connect() {
  const symbol = document.getElementById('symbol').value;
  const interval = document.getElementById('interval').value;
  const refresh = document.getElementById('refresh').value;
  const window = document.getElementById('window').value;
  const n_clusters = document.getElementById('n_clusters').value;
  const m = document.getElementById('m').value;

  const url = `/stream?symbol=${symbol}&interval=${interval}&refresh=${refresh}&window=${window}&n_clusters=${n_clusters}&m=${m}&simulate=true`;

  if (evtSource) evtSource.close();
  evtSource = new EventSource(url);

  document.getElementById("status").innerText = "Connecting...";

  evtSource.onopen = () => document.getElementById("status").innerText = "Connected";

  evtSource.onerror = () => document.getElementById("status").innerText = "Error / Disconnected";

  evtSource.onmessage = (e) => {
    const d = JSON.parse(e.data);
    if (!d.ok) return;

    renderUpdate(d);
  };
}

function disconnect() {
  if (evtSource) evtSource.close();
  document.getElementById("status").innerText = "Stopped";
}

document.getElementById("start").onclick = connect;
document.getElementById("stop").onclick = disconnect;

// INITIAL GRAPHS
Plotly.newPlot("chart", [{x:[], y:[], mode:"lines"}], {});
Plotly.newPlot("membership", [], {});

function renderUpdate(d) {
  const times = d.times.map(t => new Date(t));
  const prices = d.prices;
  const lower = d.lower;
  const upper = d.upper;

  const last = d.last.price;
  const prev = lastPrice || prices[prices.length-2] || last;
  const delta = (last - prev).toFixed(2);
  const pct = ((delta / prev) * 100).toFixed(2);

  lastPrice = last;

  document.getElementById("price").innerText = last.toFixed(2);
  document.getElementById("delta").innerText = `(${delta} / ${pct}%)`;

  Plotly.react("chart", [
    { x: times, y: prices, mode: "lines+markers", name: "Price", line: {color:"#00c8ff"} },
    { x: times, y: upper, mode: "lines", name:"Upper", line:{color:"yellow"} },
    { x: times, y: lower, mode: "lines", name:"Lower", fill:"tonexty", line:{color:"red"} }
  ], { title: d.symbol+" (Live)" });

  const mem = d.memberships;
  const traces = [];
  if (mem.length > 0) {
      for (let i=0;i<mem.length;i++) {
         traces.push({
           x: times, y: mem[i],
           mode: "lines",
           name: "Cluster "+i
         });
      }
  }
  Plotly.react("membership", traces, { title: "Fuzzy Membership" });
}
</script>

</div>
</body>
</html>
